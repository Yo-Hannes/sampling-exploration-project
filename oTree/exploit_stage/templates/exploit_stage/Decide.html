{% extends "global/Page.html" %}
{% load otree static %}
{% block title %}

{% endblock %}

{% block content %}
<div class="container">
  <div class="row" style="text-align: center;">
    <div class="col-xs-12">
      
      {% if round == 1%}
      <h2>You have now entered the Decision Stage</h2> 
      <p>
        In the following task, we will ask you to repeatedly choose between the two options you just explored. Now the outcomes of each decision count towards your final payoff.
      You will have to pay {{ switching_cost }} points to switch between options. That means if you select a button, different from the one you selected 
      in the previous round, this cost will be deducted from your total payoff. 
      You can also gain information about the option that you are not choosing in the next trial by paying {{ information_cost }} points
      by checking the little box that says "See all payoffs".
      </p>
        <p>Please make your first decision!</p>
      {% else %}
      <h2>Decision Stage</h2> 
        <p>Please pick your option but remember, if you switch it will cost you {{switching_cost}} Points</p>
      {% endif %}
      </div>
    </div>
    
    <div class="row">
      <div class="col-md-4" style="text-align: right;">
         <div class="image-container">
            <img src="{{ static symbols.0 }}" width="200px" class="response-btn" index = 0 id="{{symbols.0}}" onclick="pick_response(this)">
            <div class="payoff-text" index = 0 onclick="pick_response(this)"></div>
          </div>
        </div>

      <div class="col-md-4" style="text-align: left; font-size: small;">
        <input type = "checkbox" id="information_checkbox" name="information_checkbox">&nbsp; See all payoffs, this will cost you {{information_cost}} Points</input>
     </div>

     <div class="col-md-4" style="text-align: left;">
        <div class="image-container">
          <img src="{{ static symbols.1 }}" width="200px" class="response-btn" index = 1 id="{{symbols.1}}" onclick="pick_response(this)">
          <div class="payoff-text" index = 1 onclick="pick_response(this)"></div>
        </div>
    </div>
    <div id = "Hit_Space" style ="visibility: hidden;text-align: center; color: dodgerblue;">Please hit spacebar to continue</div>
    <div class="row" style="padding-top: 2em;">
      <div class="col-md-12">
         <table class="table" id="payoff-table" hidden>
            <thead>
              <th>Payoff</th>
              <th>Information cost</th>
              {% if round > 1 %}
                <th>Switching cost</th>
              {% endif %}
              <th>Total payoff</th>
            </thead>
            <tbody>
              <td id="payoff-cell" width="25%"></td>
              <td id="info-cell" width="25%"></td>
              {% if round > 1 %}
                <td id="switch-cell" width="25%"></td>
                {% endif %}
              <td id="total-cell" width="25%"></td>
            </tbody>
         </table>    
      </div>
    </div>

    <input type="hidden" name="choice" id="choice" value=""/>
    <input type="hidden" name="information_cost_round" id="information_cost_round" value="0"/>
    <input type="hidden" name="switching_cost_round" id="switching_cost_round" value="0"/>
    <input type="hidden" name="trial_payoff" id="trial_payoff" value="0"/>
    <input type="hidden" name="payout_left" id="payout_left" value="0"/>
    <input type="hidden" name="payout_right" id="payout_right" value="0"/>
<div> 
  
</div>
    <div class="row" style="padding-top: 2em;" hidden>
      <div class="col-md-12">
        <div style="text-align: center;"><button class="otree-btn-next btn btn-primary col-md-12">Stop exploring</button></div>
      </div>
    </div>

    <div class="col-xs-12 col-md-4"><p></p></div>
    <div class="col-md-4"></div>
    <div class="col-md-4"></div>
</div>

<script>
  // settings
  var round = {{round}};
  var information_cost = {{information_cost}};
  var switching_cost = {{switching_cost}};
  var previous_choice = "{{previous_choice}}";

  // find all buttons we defined
  var buttons = document.getElementsByClassName("response-btn");
  var payoff_text = document.getElementsByClassName("payoff-text");

  if (round > 1) {
    var iprior_choice = previous_choice == "left" ? 0 : 1;
    buttons[iprior_choice].classList.add("response-btn-prior-choice");
  }
  
  // outcome settings in left - right order
  var outcomes = {{outcomes}};
  var payoff = [{{payoff_a}}, {{payoff_b}}];
  var probability = [{{probability_a}}, {{probability_b}}];
  var payoff_input = [document.getElementById('payout_left'), document.getElementById('payout_right')]
  if (outcomes[0] == "b") {
    payoff.reverse();
    probability.reverse();
  }
  
  // cells in the table
  var payoff_cell = document.getElementById('payoff-cell');
  var info_cell = document.getElementById('info-cell');
  var switch_cell;
  if (round > 1) {
    switch_cell = document.getElementById('switch-cell');
  }
  var total_cell = document.getElementById('total-cell');
  
  // inputs that we need to set
  var choice_input = document.getElementById('choice');
  var information_checkbox = document.getElementById('information_checkbox');
  var information_input = document.getElementById('information_cost_round');
  var switch_input = document.getElementById('switching_cost_round');
  var trial_payoff = document.getElementById('trial_payoff');

  // service variables
  var button_side = ["left", "right"];
  var feedback = false; // whether it is feedback time (no further clicks are allowed)

  function reset_buttons() {
    // remove "response-btn-selected" from all buttons
    // for(var iB = 0; iB < buttons.length; iB++){
    //   buttons[iB].classList.remove("response-btn-selected");
    // }
  }

  function end_feedback() {
    // end feedback freeze stage
    reset_buttons();
    const button = document.getElementById("Hit_Space");
        button.style.visibility = "visible";
  }

  document.addEventListener("keydown", spacekey_pressed, false);
  function spacekey_pressed(e){
    if (e.code == "Space" && feedback) {
      document.getElementById('form').submit();
      e.preventDefault();
    }
    const button = document.getElementById("Hit_Space");
        button.style.visibility = "hidden"
  };

  function compute_payoff(){
     var current_payoff = [];
     for(var i = 0; i < outcomes.length; i++){
       if (Math.random() < probability[i]) {
         current_payoff[i] = payoff[i][0];
       } 
       else {
        current_payoff[i] = payoff[i][1];
       }
     }
     return current_payoff;
  }

  function pick_response(element) {
    // one response only!
    if (feedback) return;
    
    // which button was that?
    var ibutton = element.getAttribute('index');
    btn = buttons[ibutton];

    // add it to the selected button
    btn.classList.add("response-btn-selected");

    // compute payoffs
    current_payoff = compute_payoff();
    payoff_text[ibutton].innerHTML = current_payoff[ibutton];
    if (information_checkbox.checked) {
      payoff_text[1 - ibutton].innerHTML = current_payoff[1 - ibutton];
    }

    // update table
    document.getElementById("payoff-table").hidden = false;
    payoff_cell.innerHTML = current_payoff[ibutton];
    info_cell.innerHTML = information_checkbox.checked ? information_cost : 0;
    var switch_value = 0;
    if (round > 1) {
       switch_cell.innerHTML = previous_choice != button_side[ibutton] ? switching_cost : 0;
       switch_value = parseInt(switch_cell.innerHTML);
    }
    total_cell.innerHTML = parseInt(payoff_cell.innerHTML) - parseInt(info_cell.innerHTML) - switch_value;

    // store all info into inputs
    for(var iB = 0; iB < outcomes.length; iB++) {
      payoff_input[iB].value = current_payoff[iB];
    }
    information_input.value = parseInt(info_cell.innerHTML);
    switching_cost_round.value = switch_value;
    trial_payoff.value = parseInt(total_cell.innerHTML);
    choice_input.value = button_side[ibutton];
    

    // feedback time!
    feedback = true;
    window.setTimeout(end_feedback, 300);
  }
</script>

<!-- to introduce different colored buttons i have to use different button classes. 
To show the payoff I can just then print the feedback on the button in the results page 
the color of the backrgoun should depend on the previous default, what was choosen 
use classes
use bootstrap container: https://getbootstrap.com/docs/5.0/getting-started/introduction/--> 

{% endblock %}
