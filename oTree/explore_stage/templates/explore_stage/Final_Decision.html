{% extends "global/Page.html" %}
{% load otree static %}
{% block title %}

{% endblock %}

{% block content %}
<div class="container">
<div class="row">
  <div class="col-xs-12" style="text-align: center;">
    <h2>Final Decision</h2> 
    <p>Please make a final decision between the two options, before you enter the next stage.</p>
    <p>The results of your decision will be displayed at the end of the study.</p>
    <p>The payoff you earn from this decision will be added to your final payoff.</p>   
   
  </div>
</div>
<div class="row">
  {% for image in symbols %}
    <div class="col-md-6" style="text-align: center;">
      <div class="image-container">
        <img src="{{ static image }}" width="200px" class="response-btn" index = {{ forloop.counter0 }} id="{{image}}" onclick="pick_response(this)">
      </div>
    </div>
  {% endfor %}
  
  
  <input type="hidden" name="left_choice_count" id="left_choice_count" />
  <input type="hidden" name="right_choice_count" id="right_choice_count" />
  <input type="hidden" name="choice_history" id="choice_history" />
  <input type="hidden" name="choice_time" id="choice_time" />
  <input type="hidden" name="a_payoff_history" id="a_payoff_history" />
  <input type="hidden" name="b_payoff_history" id="b_payoff_history" />
      
  <!-- the inputs can be the same as in the decide page, b/c I know that the last choice is the final choice -->
  <script>
    // change text and size of next button
  
  
    // find all buttons we defined
  var buttons = document.getElementsByClassName("response-btn");

      // inputs that we need to set
  var count_inputs = [document.getElementById('left_choice_count'), document.getElementById('right_choice_count')];
  var history_input = document.getElementById('choice_history');
  var time_input = document.getElementById('choice_time');

// outcome settings in left - right order
var outcomes = {{outcomes}};
  var payoff = [{{payoff_a}}, {{payoff_b}}];
  var probability = [{{probability_a}}, {{probability_b}}];
  var payoff_input = [document.getElementById('a_payoff_history'), document.getElementById('b_payoff_history')];
  if (outcomes[0] == "b") {
    payoff.reverse();
    probability.reverse();
    payoff_input.reverse();
  }

  // servivce variables
  var click_counts = [0, 0];
  var button_side = ["l", "r"];
  var start_time = new Date().getTime();
  var feedback = false; // whether it is feedback time (no further clicks are allowed)

  function end_feedback() {
    // end feedback freeze stage
    document.getElementById("choice_history").submit(); // why can I not submit?
  }


  function compute_payoff(){
     var current_payoff = [];
     for(var i = 0; i < outcomes.length; i++){
       if (Math.random() < probability[i]) {
         current_payoff[i] = payoff[i][0];
       } 
       else {
        current_payoff[i] = payoff[i][1];
       }
     }
     return current_payoff;
  }


function pick_response(element) {
    var ibutton = element.getAttribute('index');
    btn = buttons[ibutton];
    
    // too soon!
    if (feedback) return;

    // add it to the selected button
    btn.classList.add("response-btn-selected");

    // compute payoffs
    current_payoff = compute_payoff();
    
    // update logs
    click_counts[ibutton] += 1;
    count_inputs[ibutton].value = click_counts[ibutton];
    history_input.value = history_input.value + button_side[ibutton];
    time_input.value = time_input.value + " " + (new Date().getTime() - start_time);
    for(var iB = 0; iB < outcomes.length; iB++) {
      payoff_input[iB].value = payoff_input[iB].value + " " + current_payoff[iB];
    }

    // feedback time!
    feedback = true;
    window.setTimeout(end_feedback, 300);
  }
</script>
{% endblock %}